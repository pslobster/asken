name: Gemini AI Partner

on:
  issue_comment:
    types: [created, edited]

jobs:
  gemini_process:
    if: contains(github.event.comment.body, '@gemini')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Google AI Library
        run: pip install -q -U google-generativeai

      - name: Gemini AI Logic
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          python << 'EOF'
          import os
          import sys
          import google.generativeai as genai

          def run():
              api_key = os.environ.get("GEMINI_API_KEY")
              if not api_key:
                  print("::error::GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
                  sys.exit(1)

              genai.configure(api_key=api_key)
              model = genai.GenerativeModel('gemini-3-flash-preview')

              prompt = f"""
              ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŒ‡ç¤ºã‚’è§£æžã—ã€ä»¥ä¸‹ã«å¾“ã£ã¦ãã ã•ã„ã€‚
              1. ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦ãªã‚‰ ```bash ... ``` å½¢å¼ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‡ºåŠ›ã€‚
              2. è³ªå•ã‚„åŠ©è¨€ãªã‚‰ã€ãã®ã¾ã¾æ—¥æœ¬èªžã§å›žç­”ã€‚
              
              [è¶…é‡è¦ï¼šè‡ªå‹•å®Ÿè¡Œã®å¾¹åº•]
              - .github/workflows. é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ä½œæˆãƒ»å¤‰æ›´ã—ãªã„ã§ãã ã•ã„ã€‚
              - ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š(.github/workflows/deploy.yml)ã«ã¤ã„ã¦ã¯è‡ªå‹•ã§ä½œæˆã›ãšã€issueå†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ä½œæˆæ„å›³ã¨è¨˜è¼‰å†…å®¹ã‚’ãƒãƒ£ãƒƒãƒˆã—ã¦ä¸‹ã•ã„ã€‚
              - ã™ã¹ã¦ã® npm/npx ã‚³ãƒžãƒ³ãƒ‰ã«ã¯å¿…ãš `--yes` (ã¾ãŸã¯ `-y`) ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚
              - æ—¢å­˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« Vite ã‚’å±•é–‹ã™ã‚‹å ´åˆã€å¿…ãš `--yes` ã‚’ä»˜ã‘ã¦ã€Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ãªã„ã€ã¨ã„ã†è­¦å‘Šã‚’ã‚¹ã‚­ãƒƒãƒ—ã•ã›ã¦ãã ã•ã„ã€‚
              - ä¾‹: `npm create vite@latest . --yes -- --template react-ts`
              
              æŒ‡ç¤ºå†…å®¹: {os.environ.get('COMMENT_BODY')}
              å¯¾è±¡Issue: {os.environ.get('ISSUE_TITLE')}
              """

              try:
                  response = model.generate_content(prompt)
                  res_text = response.text
                  
                  if "```bash" in res_text:
                      parts = res_text.split("```bash")
                      explanation = parts[0].strip()
                      script = parts[1].split("```")[0].strip()
                      with open("explanation.md", "w", encoding="utf-8") as f: f.write(explanation)
                      with open("update_code.sh", "w", encoding="utf-8") as f: f.write(script)
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write("has_fix=true\n")
                  else:
                      with open("explanation.md", "w", encoding="utf-8") as f: f.write(res_text)
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write("has_fix=false\n")
              except Exception as e:
                  print(f"::error::Python Error: {e}")
                  sys.exit(1)
          run()
          EOF

      - name: Git Push with Auth
        if: steps.gemini.outputs.has_fix == 'true'
        id: git_push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # <<<< ã€è¿½åŠ ã€‘ç’°å¢ƒå¤‰æ•° CI ã‚’ true ã«ã—ã¦ npm ã®å¯¾è©±ã‚’æŠ‘åˆ¶
          CI: true
        run: |
          BRANCH_NAME="gemini-fix-${{ github.event.issue.number }}"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          
          chmod +x update_code.sh
          # <<<< ã€è¿½åŠ ã€‘å®Ÿè¡Œæ™‚ã«ã‚‚å¯¾è©±ã‚’æŠ‘åˆ¶ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸Ž
          ./update_code.sh || { echo "::error::ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå¤±æ•—ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"; exit 1; }
          
          git add .
          if ! git diff --cached --exit-code; then
            git commit -m "AI suggested changes from Issue #${{ github.event.issue.number }}"
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "$BRANCH_NAME" --force || { echo "::error::GitHubã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; exit 1; }
            
            COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/main...${BRANCH_NAME}?expand=1"
            echo "pr_link=$COMPARE_URL" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::å¤‰æ›´ãªã—"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Final Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### ðŸ¤– Geminiã‹ã‚‰ã®è¿”ç­”" > final_comment.md
          cat explanation.md >> final_comment.md
          
          if [ "${{ steps.git_push.outputs.has_changes }}" == "true" ]; then
            echo -e "\n\n---\n### ðŸ›  ä¿®æ­£æ¡ˆã‚’ç¢ºèªã—ã¦ãã ã•ã„\n[ðŸ‘‰ ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ](${{ steps.git_push.outputs.pr_link }})" >> final_comment.md
          fi
          
          gh issue comment ${{ github.event.issue.number }} --body-file final_comment.md
