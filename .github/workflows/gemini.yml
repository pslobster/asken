name: Gemini AI Partner

on:
  issue_comment:
    types: [created, edited]

jobs:
  gemini_process:
    if: contains(github.event.comment.body, '@gemini')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Google AI Library
        run: pip install -q -U google-generativeai

      - name: Gemini AI Logic
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          python << 'EOF'
          import os
          import sys
          import google.generativeai as genai
          from google.api_core import exceptions

          def run():
              api_key = os.environ.get("GEMINI_API_KEY")
              if not api_key:
                  print("::error::GEMINI_API_KEY ãŒ GitHub Secrets ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
                  sys.exit(1)

              try:
                  genai.configure(api_key=api_key)
                  # 2026å¹´æœ€æ–°ã® Gemini 3 Flash ã‚’ä½¿ç”¨
                  model = genai.GenerativeModel('gemini-3-flash-preview')

                  prompt = f"""
                  ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®æŒ‡ç¤ºã‚’è§£æžã—ã¦ãã ã•ã„ã€‚
                  æŒ‡ç¤ºå†…å®¹: {os.environ.get('COMMENT_BODY')}
                  å¯¾è±¡Issue: {os.environ.get('ISSUE_TITLE')}

                  [ãƒ«ãƒ¼ãƒ«]
                  - ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦ãªã‚‰ ```bash ... ``` ã§å›²ã£ãŸå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‡ºåŠ›ã€‚
                  - è³ªå•ã‚„åŠ©è¨€ãªã‚‰ã€ãã®ã¾ã¾æ—¥æœ¬èªžã§å›žç­”ã€‚
                  """

                  print("--- Gemini API å‘¼ã³å‡ºã—ä¸­ ---")
                  response = model.generate_content(prompt)
                  
                  if not response.candidates:
                      print("::error::AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™ã€‚å®‰å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
                      sys.exit(1)

                  res_text = response.text
                  
                  # å‡ºåŠ›ã®ä¿å­˜
                  if "```bash" in res_text:
                      parts = res_text.split("```bash")
                      explanation = parts[0].strip()
                      script = parts[1].split("```")[0].strip()
                      with open("explanation.md", "w") as f: f.write(explanation)
                      with open("update_code.sh", "w") as f: f.write(script)
                      # Actionsã«ã€Œä¿®æ­£ã‚ã‚Šã€ã‚’é€šçŸ¥
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write("has_fix=true\n")
                  else:
                      with open("explanation.md", "w") as f: f.write(res_text)
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write("has_fix=false\n")

              except exceptions.PermissionDenied:
                  print("::error::APIã‚­ãƒ¼ãŒç„¡åŠ¹ã€ã¾ãŸã¯æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚AI Studioã®ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
                  sys.exit(1)
              except exceptions.ResourceExhausted:
                  print("::error::APIã®åˆ©ç”¨åˆ¶é™ï¼ˆãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆï¼‰ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰è©¦ã—ã¦ãã ã•ã„ã€‚")
                  sys.exit(1)
              except Exception as e:
                  print(f"::error::äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                  sys.exit(1)

          run()
          EOF

      - name: Git Operations and Push
        if: steps.gemini.outputs.has_fix == 'true'
        id: git_push
        run: |
          BRANCH_NAME="gemini-fix-${{ github.event.issue.number }}"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ãƒ–ãƒ©ãƒ³ãƒä½œæˆã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          git checkout -b $BRANCH_NAME || git checkout $BRANCH_NAME
          chmod +x update_code.sh
          ./update_code.sh || { echo "::error::AIãŒç”Ÿæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; exit 1; }
          
          # å·®åˆ†ãŒã‚ã‚‹ã‹ç¢ºèª
          if [ -z "$(git status --porcelain)" ]; then
            echo "::warning::æŒ‡ç¤ºã«å¾“ã£ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸãŒã€ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git add .
            git commit -m "AI suggested changes from Issue #${{ github.event.issue.number }}"
            git push origin $BRANCH_NAME --force || { echo "::error::GitHubã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; exit 1; }
            
            COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/main...${BRANCH_NAME}?expand=1"
            echo "pr_link=$COMPARE_URL" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Post Final Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ™ãƒ¼ã‚¹ä½œæˆ
          echo "### ðŸ¤– Geminiã‹ã‚‰ã®è¿”ç­”" > final_comment.md
          cat explanation.md >> final_comment.md
          
          if [ "${{ steps.git_push.outputs.has_changes }}" == "true" ]; then
            echo -e "\n\n---\n### ðŸ›  ä¿®æ­£æ¡ˆã‚’ãƒ–ãƒ©ãƒ³ãƒã«åæ˜ ã—ã¾ã—ãŸ\nä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å†…å®¹ã‚’ç¢ºèªã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š\n[ðŸ‘‰ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹](${{ steps.git_push.outputs.pr_link }})" >> final_comment.md
          fi
          
          gh issue comment ${{ github.event.issue.number }} --body-file final_comment.md
