name: Gemini AI Issue Assistant

on:
  issue_comment:
    # 2. ç·¨é›†æ™‚ (edited) ã‚‚å¯¾è±¡ã«è¿½åŠ 
    types: [created, edited]

jobs:
  gemini_process:
    # @gemini ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: contains(github.event.comment.body, '@gemini')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Library
        run: pip install -q -U google-generativeai

      - name: Gemini AI Processing
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import sys
          import google.generativeai as genai

          genai.configure(api_key=os.environ["GEMINI_API_KEY"])
          model = genai.GenerativeModel('gemini-3-flash-preview')

          prompt = f"""
          ã‚ãªãŸã¯å„ªç§€ãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®Issueã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ã€é©åˆ‡ã«å¯¾å¿œã—ã¦ãã ã•ã„ã€‚

          [å¯¾å¿œãƒ«ãƒ¼ãƒ«]
          1. è³ªå•ã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸå ´åˆï¼š
             è¦ªåˆ‡ãªè§£èª¬ã‚’æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã¯ä¸è¦ã§ã™ã€‚
          2. ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã‚’ä¾é ¼ã•ã‚ŒãŸå ´åˆï¼š
             ã¾ãšã€Œã©ã®ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹ã‹ã€ã®æ¦‚è¦ã‚’æ—¥æœ¬èªã§æ›¸ãã€ãã®å¾Œã«ä¿®æ­£ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ ```bash ... ``` å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

          [å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ]
          èª¬æ˜æ–‡ï¼ˆæ—¥æœ¬èªï¼‰
          (ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã®ã¿)
          ```bash
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…å®¹
          ```

          æŒ‡ç¤ºå†…å®¹: ${{ github.event.comment.body }}
          å¯¾è±¡Issue: ${{ github.event.issue.title }}
          """

          try:
              response = model.generate_content(prompt).text
              
              # å‡ºåŠ›ã®åˆ†é›¢å‡¦ç†
              if "```bash" in response:
                  parts = response.split("```bash")
                  explanation = parts[0].strip()
                  script = parts[1].split("```")[0].strip()
                  with open("explanation.md", "w") as f: f.write(explanation)
                  with open("update_code.sh", "w") as f: f.write(script)
              else:
                  with open("explanation.md", "w") as f: f.write(response)
          except Exception as e:
              print(f"Error: {e}")
              sys.exit(1)
          EOF

      # 3. ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒã‚ã‚‹å ´åˆï¼šãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push Changes to Branch
        if: hashFiles('update_code.sh') != ''
        id: git_push
        run: |
          BRANCH_NAME="gemini-fix-${{ github.event.issue.number }}"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b $BRANCH_NAME
          chmod +x update_code.sh
          ./update_code.sh
          
          git add .
          git commit -m "AI suggested changes from Issue #${{ github.event.issue.number }}"
          git push origin $BRANCH_NAME --force
          
          # 1. PRä½œæˆç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
          COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/main...${BRANCH_NAME}?expand=1"
          echo "PR_LINK=$COMPARE_URL" >> $GITHUB_OUTPUT
          echo "HAS_FIX=true" >> $GITHUB_OUTPUT

      # 1 & 3. æœ€çµ‚çš„ãªå›ç­”ã‚’Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Post Comment to Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ„ã¿ç«‹ã¦
          cat explanation.md > final_comment.md
          
          if [ "${{ steps.git_push.outputs.HAS_FIX }}" == "true" ]; then
            echo -e "\n\n---" >> final_comment.md
            echo "### ğŸ›  AIã«ã‚ˆã‚‹ä¿®æ­£æ¡ˆãŒæº–å‚™ã§ãã¾ã—ãŸ" >> final_comment.md
            echo "å†…å®¹ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š" >> final_comment.md
            echo "[ğŸ‘‰ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦å†…å®¹ã‚’ç¢ºèªã™ã‚‹](${{ steps.git_push.outputs.PR_LINK }})" >> final_comment.md
          fi
          
          gh issue comment ${{ github.event.issue.number }} --body-file final_comment.md
