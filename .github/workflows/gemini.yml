name: Gemini AI PR Creator

on:
  issue_comment:
    types: [created]

jobs:
  create_pr:
    if: contains(github.event.comment.body, '@gemini')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Google Generative AI Library
        run: pip install -q -U google-generativeai

      - name: Generate Code Fix with Gemini
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF' > update_code.sh
          import os
          import google.generativeai as genai

          genai.configure(api_key=os.environ["GEMINI_API_KEY"])
          model = genai.GenerativeModel('gemini-1.5-flash') # 2026年最新の安定版

          prompt = f"""
          あなたはシニアエンジニアです。以下の指示に従い、リポジトリのファイルを修正するbashスクリプトを作成してください。
          解説は不要です。bashスクリプトの内容のみを出力してください。
          
          指示: ${{ github.event.comment.body }}
          対象Issue: ${{ github.event.issue.title }}
          """

          response = model.generate_content(prompt)
          # コードブロックが含まれている場合は中身だけ抽出
          code = response.text.replace('```bash', '').replace('```', '').strip()
          print(code)
          EOF

      - name: Execute Generated Script
        run: |
          chmod +x update_code.sh
          ./update_code.sh

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "AI fix by Gemini"
          title: "AI Fix: ${{ github.event.issue.title }}"
          body: "Generated by Gemini AI in response to Issue comment."
          branch: gemini-patch-${{ github.event.issue.number }}
