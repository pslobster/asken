name: Gemini AI Partner

on:
  issue_comment:
    # æ–°è¦æŠ•ç¨¿ã¨ç·¨é›†ã®ä¸¡æ–¹ã«å¯¾å¿œ
    types: [created, edited]

jobs:
  gemini_process:
    # @gemini ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: contains(github.event.comment.body, '@gemini')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Google AI Library
        run: pip install -q -U google-generativeai

      - name: Gemini AI Logic
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          python << 'EOF'
          import os
          import sys
          import google.generativeai as genai

          def run():
              api_key = os.environ.get("GEMINI_API_KEY")
              if not api_key:
                  print("::error::GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
                  sys.exit(1)

              genai.configure(api_key=api_key)
              model = genai.GenerativeModel('gemini-3-flash-preview')

              prompt = f"""
              ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®æŒ‡ç¤ºã‚’è§£æã—ã¦ãã ã•ã„ã€‚
              æŒ‡ç¤ºå†…å®¹: {os.environ.get('COMMENT_BODY')}
              å¯¾è±¡Issue: {os.environ.get('ISSUE_TITLE')}

              [ãƒ«ãƒ¼ãƒ«]
              - ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦ãªã‚‰ã€å®Ÿè¡Œå¯èƒ½ãªbashã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ ```bash ... ``` ã§å›²ã£ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
              - ãã‚Œä»¥å¤–ï¼ˆè³ªå•ã‚„åŠ©è¨€ï¼‰ã¯ã€ãã®ã¾ã¾æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
              - è§£èª¬ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¸¡æ–¹å‡ºã™å ´åˆã¯ã€å…ˆã«è§£èª¬ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
              """

              try:
                  response = model.generate_content(prompt)
                  if not response or not response.text:
                      print("::error::AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™ã€‚")
                      sys.exit(1)
                  
                  res_text = response.text
                  
                  # ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å¼·åŒ–
                  if "```bash" in res_text:
                      parts = res_text.split("```bash")
                      explanation = parts[0].strip()
                      script = parts[1].split("```")[0].strip()
                      
                      with open("explanation.md", "w", encoding="utf-8") as f: f.write(explanation)
                      with open("update_code.sh", "w", encoding="utf-8") as f: f.write(script)
                      
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write("has_fix=true\n")
                  else:
                      with open("explanation.md", "w", encoding="utf-8") as f: f.write(res_text)
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f: f.write("has_fix=false\n")
              except Exception as e:
                  print(f"::error::Gemini API Error: {e}")
                  sys.exit(1)
          run()
          EOF

      - name: Git Push with Auth
        if: steps.gemini.outputs.has_fix == 'true'
        id: git_push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="gemini-fix-${{ github.event.issue.number }}"
          
          # Gitã®åŸºæœ¬è¨­å®š
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆãƒ»åˆ‡ã‚Šæ›¿ãˆ
          git checkout -b "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          
          # AIãŒç”Ÿæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          chmod +x update_code.sh
          ./update_code.sh
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
          git add .
          if ! git diff --cached --exit-code; then
            git commit -m "AI fix for issue #${{ github.event.issue.number }}"
            # èªè¨¼ã‚’å«ã‚ãŸURLã§ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆæœ€ã‚‚ç¢ºå®Ÿãªæ–¹æ³•ï¼‰
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "$BRANCH_NAME" --force
            
            # PRãƒªãƒ³ã‚¯ã®ä½œæˆ
            REPO_URL="${{ github.server_url }}/${{ github.repository }}"
            echo "pr_link=${REPO_URL}/compare/main...${BRANCH_NAME}?expand=1" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸãŒãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Comment to Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ§‹ç¯‰
          echo "### ğŸ¤– Geminiã®å›ç­”" > final_comment.md
          cat explanation.md >> final_comment.md
          
          if [ "${{ steps.git_push.outputs.has_changes }}" == "true" ]; then
            echo -e "\n\n---\n### ğŸ›  ã‚³ãƒ¼ãƒ‰ä¿®æ­£æ¡ˆãŒæº–å‚™ã§ãã¾ã—ãŸ\nå†…å®¹ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š\n[ğŸ‘‰ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹](${{ steps.git_push.outputs.pr_link }})" >> final_comment.md
          fi
          
          gh issue comment ${{ github.event.issue.number }} --body-file final_comment.md
